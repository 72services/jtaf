<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Edit Athlete</title>
        <link rel="stylesheet" href="css/jtaf.css">
        <script src="javascript/util.js"></script>
        <script>
            var athlete;
            var serie;
            var competition;
            var clubs;

            function loadData() {
                if (serie === undefined) {
                    var s = localStorage.getItem("serie");
                    serie = JSON.parse(s);
                }

                xhrGet("/jtaf/res/clubs", function(response) {
                    clubs = JSON.parse(response);
                });

                var id = param().id;
                if (id === undefined) {
                    athlete = new Object();
                    el("athlete_lastName").focus();
                } else {
                    xhrGet("/jtaf/res/athletes/" + id, function(response) {
                        parseAndFill(response);
                    });
                }
            }

            function fillClubSelect() {
                var select = el("athlete_club");
                for (var i in clubs) {
                    var club = clubs[i];
                    var option = document.createElement("option");
                    option.value = club.id;
                    option.innerHTML = club.abbrevation;
                    select.appendChild(option);
                    if (athlete.club !== undefined && athlete.club !== null &&
                            athlete.club.id === club.id) {
                        option.selected = true;
                    }
                }
            }

            function back() {
                window.location = "serie.html?id=" + serie.id;
            }

            function parseAndFill(response) {
                athlete = JSON.parse(response);
                fillForm();
            }

            function fillForm() {
                el("athlete_id").value = athlete.id;
                el("athlete_lastName").value = athlete.lastName;
                el("athlete_lastName").focus();
                el("athlete_firstName").value = athlete.firstName;
                el("athlete_year").value = athlete.year;
                if (athlete.gender === "m") {
                    el("athlete_gender_m").checked = true;
                }
                else {
                    el("athlete_gender_f").checked = true;
                }
                el("athlete_category").value = athlete.category.abbrevation;
                fillClubSelect()
                        ;
                competition = JSON.parse(localStorage.getItem("competition"));
                if (athlete.category !== undefined
                        && competition !== undefined
                        && competition !== null) {
                    el("results").setAttribute("style", "visbility: visible;");
                    el("competition").appendChild(document.createTextNode(competition.name));
                    fillEventsTable();
                }
            }

            function fillEventsTable() {
                var table = el("athlete_events");
                table.innerHTML = "";

                if (athlete.category !== undefined) {
                    for (var i in athlete.category.events) {
                        var aevent = athlete.category.events[i];
                        var row = table.insertRow(i);
                        var cellName = row.insertCell(0);
                        cellName.innerHTML = aevent.name;

                        var cellResult = row.insertCell(1);
                        var result = document.createElement("input");
                        result.setAttribute("type", "text");
                        result.id = "result" + i;
                        result.setAttribute("style", "width: 100px");
                        result.setAttribute("onblur", "calculatePoints(" + i + ")");
                        cellResult.appendChild(result);
                        var cellPoints = row.insertCell(2);

                        var points = document.createElement("input");
                        points.id = "points" + i;
                        points.setAttribute("type", "text");
                        points.setAttribute("readonly");
                        points.setAttribute("disabled");
                        points.setAttribute("style", "width: 100px");
                        cellPoints.appendChild(points);

                        if (athlete.results[i] !== undefined) {
                            result.value = athlete.results[i].result;
                            points.value = athlete.results[i].points;
                        }
                    }
                    el("result0").focus();
                }
            }

            function calculatePoints(i) {
                var ev = athlete.category.events[i];
                var result = el("result" + i).value;

                var points = 0;
                if (ev.type === "run") {
                    // A*((B-L)/100)^C
                    points = ev.a * Math.pow((ev.b - result * 100) / 100, ev.c);
                }
                else if (ev.type === "throw") {
                    // A*((L-B)/100)^C
                    points = ev.a * Math.pow((result * 100 - ev.b) / 100, ev.c);
                }
                else if (ev.type === "jump") {
                    // A*(L-B)^C
                    points = ev.a * Math.pow((result * 100 - ev.b) / 100, ev.c);
                }
                points = Math.round(points);
                if (points < 0) {
                    points = 0;
                }
                var resultObject = new Object();
                resultObject.result = result;
                resultObject.points = points;
                resultObject.event = ev;
                resultObject.competition = competition;
                athlete.results[i] = resultObject;
                el("points" + i).value = points;
            }

            function save() {
                fillAthlete();
                xhrPost("/jtaf/res/athletes/", function(response) {
                    parseAndFill(response);
                    info("Athlete saved");
                }, athlete);
            }

            function fillAthlete() {
                athlete.firstName = el("athlete_firstName").value;
                athlete.lastName = el("athlete_lastName").value;
                athlete.year = el("athlete_year").value;
                if (el("athlete_gender_m").checked) {
                    athlete.gender = "m";
                } else {
                    athlete.gender = "f";
                }
                athlete.serie = serie;
            }

            function deleteAthlete(id) {
                xhrDelete("/jtaf/res/athletes/" + id, function() {
                    loadData();
                    info("Athlete deleted");
                });
            }
        </script>
    </head>
    <body onload="loadData();">
        <div id="main">
            <div id="navigation">
                <script src="javascript/navigation.js"></script>
            </div>

            <h1>Athlete</h1>

            <form action="javascript:save();">

                <table class="input">
                    <tr>
                        <td>Id</td>
                        <td><input type="text" id="athlete_id" readonly disabled /></td>
                    </tr>
                    <tr>
                        <td>Last name</td>
                        <td><input type="text" id="athlete_lastName" required /></td>
                    </tr>
                    <tr>
                        <td>First name</td>
                        <td><input type="text" id="athlete_firstName" required /></td>
                    </tr>
                    <tr>
                        <td>Year</td>
                        <td><input type="number" min="1900" max="2100" id="athlete_year" required /></td>
                    </tr>
                    <tr>
                        <td>Gender</td>
                        <td>
                            <input id="athlete_gender_m" type="radio" name="athlete_gender" value="m">m
                            <input id="athlete_gender_f" type="radio" name="athlete_gender" value="f">f
                        </td>
                    </tr>
                    <tr>
                        <td>Category</td>
                        <td><input type="text" id="athlete_category" readonly disabled /></td>
                    </tr>
                    <tr>
                        <td>Club</td>
                        <td><select id="athlete_club"></select></td>
                    </tr>
                </table>

                <p>
                    <input type="submit" value="Save" />&nbsp;
                    <a href="javascript:back();">Back</a>
                </p>

                <div id="results" style="visibility: hidden;">

                    <h2>Results</h2>
                    <h3 id="competition"></h3>

                    <table id="athlete_events" class="input">
                    </table>

                </div>

            </form>

        </div>
    </body>
</html>
