<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Edit serie</title>
        <link rel="stylesheet" href="css/jtaf.css">

        <script src="javascript/util.js"></script>
        <script src="javascript/navigation.js"></script>
        <script>
            var serie;

            function loadData() {
                var id = param().id;
                if (id === undefined) {
                    serie = new Object();
                    el("serie_name").focus();
                } else {
                    sendRequest("GET", "/jtaf/res/series/" + id, 200, function(response) {
                        parseAndFillSerie(response);
                    });
                    sendRequest("GET", "/jtaf/res/categories?serie=" + id, 200, function(response) {
                        parseAndFillCategories(response);
                    });
                    sendRequest("GET", "/jtaf/res/events?serie=" + id, 200, function(response) {
                        parseAndFillEvents(response);
                    });
                }
            }

            function parseAndFillSerie(response) {
                serie = JSON.parse(response);
                sessionStorage.setItem("serie", response);

                fillForm();
                fillCompetitionTable();
            }

            function fillForm() {
                el("serie_id").value = serie.id;
                el("serie_name").value = serie.name;
                el("serie_name").focus();
            }

            function fillCompetitionTable() {
                var table = el("competition_table");
                table.innerHTML = "";
                if (serie.competitions === undefined || serie.competitions.length === 0) {
                    var row = table.insertRow(0);
                    var cellName = row.insertCell(0);
                    cellName.innerHTML = "No competitions found";
                    cellName.setAttribute("colspan", 3);
                }
                else {
                    for (var i in serie.competitions) {
                        var competition = serie.competitions[i];
                        var row = table.insertRow(i);
                        var onclickEdit = "window.location = 'competition.html?id=" +
                                competition.id + "'";
                        var cellName = row.insertCell(0);
                        cellName.className = "edit";
                        cellName.innerHTML = competition.name;
                        cellName.setAttribute("onclick", onclickEdit);
                        var cellDate = row.insertCell(1);
                        cellDate.className = "edit";
                        cellDate.innerHTML = competition.competitionDate;
                        cellDate.setAttribute("onclick", onclickEdit);
                        var del = document.createElement("a");
                        del.setAttribute("href", "#");
                        del.setAttribute("onclick", "deleteCompetition(" +
                                competition.id + ")");
                        del.appendChild(document.createTextNode("Delete"));
                        var cellFunction = row.insertCell(2);
                        cellFunction.appendChild(del);
                    }
                }
            }

            function parseAndFillCategories(response) {
                var categories = JSON.parse(response);
                var table = el("category_table");
                table.innerHTML = "";
                if (categories === undefined || categories.length === 0) {
                    var row = table.insertRow(0);
                    var cellName = row.insertCell(0);
                    cellName.innerHTML = "No competitions found";
                    cellName.setAttribute("colspan", 6);
                }
                else {
                    for (var i in categories) {
                        var category = categories[i];
                        var row = table.insertRow(i);
                        var onclickEdit = "window.location = 'category.html?id=" +
                                category.id + "'";
                        var cellAbbr = row.insertCell(0);
                        cellAbbr.className = "edit";
                        cellAbbr.innerHTML = category.abbrevation;
                        cellAbbr.setAttribute("onclick", onclickEdit);
                        var cellName = row.insertCell(1);
                        cellName.className = "edit";
                        cellName.innerHTML = category.name;
                        cellName.setAttribute("onclick", onclickEdit);
                        var cellYearFrom = row.insertCell(2);
                        cellYearFrom.className = "edit";
                        cellYearFrom.innerHTML = category.yearFrom;
                        cellYearFrom.setAttribute("onclick", onclickEdit);
                        var cellYearTo = row.insertCell(3);
                        cellYearTo.className = "edit";
                        cellYearTo.innerHTML = category.yearTo;
                        cellYearTo.setAttribute("onclick", onclickEdit);
                        var cellGender = row.insertCell(4);
                        cellGender.className = "edit";
                        cellGender.innerHTML = category.gender;
                        cellGender.setAttribute("onclick", onclickEdit);
                        var del = document.createElement("a");
                        del.setAttribute("href", "#");
                        del.setAttribute("onclick", "deleteCategory(" +
                                category.id + ")");
                        del.appendChild(document.createTextNode("Delete"));
                        var cellFunction = row.insertCell(5);
                        cellFunction.appendChild(del);
                    }
                }
            }

            function parseAndFillEvents(response) {
                var events = JSON.parse(response);
                var table = el("event_table");
                table.innerHTML = "";
                if (events === undefined || events.length === 0) {
                    var row = table.insertRow(0);
                    var cellName = row.insertCell(0);
                    cellName.innerHTML = "No events found";
                    cellName.setAttribute("colspan", 7);
                }
                else {
                    for (var i in events) {
                        var event = events[i];
                        var row = table.insertRow(i);
                        var onclickEdit = "window.location = 'event.html?id=" +
                                event.id + "'";
                        var cellName = row.insertCell(0);
                        cellName.className = "edit";
                        cellName.innerHTML = event.name;
                        cellName.setAttribute("onclick", onclickEdit);
                        var cellType = row.insertCell(1);
                        cellType.className = "edit";
                        cellType.innerHTML = event.type;
                        cellType.setAttribute("onclick", onclickEdit);
                        var cellGender = row.insertCell(2);
                        cellGender.className = "edit";
                        cellGender.innerHTML = event.gender;
                        cellGender.setAttribute("onclick", onclickEdit);
                        var cellA = row.insertCell(3);
                        cellA.className = "edit";
                        cellA.innerHTML = event.a;
                        cellA.setAttribute("onclick", onclickEdit);
                        var cellB = row.insertCell(4);
                        cellB.className = "edit";
                        cellB.innerHTML = event.b;
                        cellB.setAttribute("onclick", onclickEdit);
                        var cellC = row.insertCell(5);
                        cellC.className = "edit";
                        cellC.innerHTML = event.c;
                        cellC.setAttribute("onclick", onclickEdit);
                        var del = document.createElement("a");
                        del.setAttribute("href", "#");
                        del.setAttribute("onclick", "deleteEvent(" + event.id + ")");
                        del.appendChild(document.createTextNode("Delete"));
                        var cellFunction = row.insertCell(6);
                        cellFunction.appendChild(del);
                    }
                }
            }

            function save() {
                fillSerie();
                sendRequest("POST", "/jtaf/res/series/", 200, function(response) {
                    loadData();
                    info("Serie saved");
                }, "application/json", JSON.stringify(serie));
            }

            function fillSerie() {
                serie.name = el("serie_name").value;
            }

            function deleteCompetition(id) {
                sendRequest("DELETE", "/jtaf/res/competitions/" + id, 204, function() {
                    loadData();
                    info("Competition deleted");
                });
            }

            function deleteCategory(id) {
                sendRequest("DELETE", "/jtaf/res/catgories/" + id, 204, function() {
                    loadData();
                    info("Category deleted");
                });
            }

            function deleteEvent(id) {
                sendRequest("DELETE", "/jtaf/res/catgories/" + id, 204, function() {
                    loadData();
                    info("Event deleted");
                });
            }
        </script>
    </head>
    <body onload="loadData();">
        <div id="main">
            <div id="navigation">
                <script src="javascript/navigation.js"></script>
            </div>

            <h1>Serie</h1>

            <form action="javascript:save();">

                <table class="input">
                    <tr>
                        <td>Id</td>
                        <td><input type="text" id="serie_id" readonly disabled /></td>
                    </tr>
                    <tr>
                        <td>Name</td>
                        <td><input type="text" id="serie_name" required /></td>
                    </tr>
                </table>

                <p>
                    <input type="submit" value="Save" />&nbsp;<a href="index.html">Back</a>
                </p>

                <h2>Competitions</h2>

                <table class="result">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Date</th>
                            <th style="width: 40px"></th>
                        </tr>
                    </thead>
                    <tbody id="competition_table">
                        <tr>
                            <td colspan="3">Loading competitions</td>
                        </tr>
                    </tbody>
                </table>

                <p>
                    <a href="competition.html">Add competition</a>
                </p>

                <h2>Events</h2>

                <table class="result">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Gender</th>
                            <th>A</th>
                            <th>B</th>
                            <th>C</th>
                            <th style="width: 40px"></th>
                        </tr>
                    </thead>
                    <tbody id="event_table">
                        <tr>
                            <td colspan="7">Loading events</td>
                        </tr>
                    </tbody>
                </table>

                <p>
                    <a href="event.html">Add event</a>
                </p>

                <h2>Categories</h2>

                <table class="result">
                    <thead>
                        <tr>
                            <th>Key</th>
                            <th>Name</th>
                            <th>From</th>
                            <th>To</th>
                            <th>Gender</th>
                            <th style="width: 40px"></th>
                        </tr>
                    </thead>
                    <tbody id="category_table">
                        <tr>
                            <td colspan="6">Loading categories</td>
                        </tr>
                    </tbody>
                </table>

                <p>
                    <a href="category.html">Add category</a>
                </p>

            </form>

        </div>
    </body>
</html>
