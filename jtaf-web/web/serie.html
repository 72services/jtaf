<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Edit serie</title>
        <link rel="stylesheet" href="css/jtaf.css">

        <script src="javascript/util.js"></script>
        <script src="javascript/navigation.js"></script>
        <script>
            var serie;

            function getSerie() {
                var id = param().id;
                if (id === undefined) {
                    serie = new Object();
                    el("serie_name").focus();
                } else {
                    sendRequest("GET", "/jtaf/res/series/" + id, 200, function(response) {
                        parseAndFill(response);
                    });
                }
            }

            function addCompetition() {
                window.location = "competition.html?serieId=" + serie.id;
            }

            function parseAndFill(response) {
                serie = JSON.parse(response);
                fillForm();
                fillTable();
            }

            function fillForm() {
                el("serie_id").value = serie.id;
                el("serie_name").value = serie.name;
                el("serie_name").focus();
            }

            function fillTable() {
                if (serie.competitions.length > 0) {
                    var table = el("competition_table");
                    table.innerHTML = "";

                    for (var i in serie.competitions) {
                        var competition = serie.competitions[i];
                        var row = table.insertRow(i);
                        row.className = "result";

                        var onclickEdit = "window.location = 'competition.html?id=" +
                                competition.id + "'";

                        var cellName = row.insertCell(0);
                        cellName.className = "result edit";
                        cellName.innerHTML = competition.name;
                        cellName.setAttribute("onclick", onclickEdit);

                        var cellDate = row.insertCell(1);
                        cellDate.className = "result edit";
                        cellDate.innerHTML = competition.competitionDate;
                        cellDate.setAttribute("onclick", onclickEdit);

                        var del = document.createElement("a");
                        del.setAttribute("href", "#");
                        del.setAttribute("onclick", "deleteCompetition(" +
                                competition.id + ")");
                        del.appendChild(document.createTextNode("Delete"));

                        var cellFunction = row.insertCell(2);
                        cellFunction.className = "result";
                        cellFunction.appendChild(del);
                    }
                }
            }

            function save() {
                fillSerie();
                sendRequest("POST", "/jtaf/res/series/", 200, function(response) {
                    parseAndFill(response);
                    info("Serie saved");
                }, "application/json", JSON.stringify(serie));
            }

            function fillSerie() {
                serie.name = el("serie_name").value;
            }

            function deleteCompetition(id) {
                sendRequest("DELETE", "/jtaf/res/competitions/" + id, 204, function() {
                    listSeries();
                    info("Competition deleted");
                });
            }
        </script>
    </head>
    <body onload="getSerie();">
        <div id="main">
            <div id="navigation">
                <script src="javascript/navigation.js"></script>
            </div>

            <h1>Serie</h1>

            <form action="javascript:save();">

                <table style="width: 100%">
                    <tr>
                        <td>Id</td>
                        <td><input type="text" id="serie_id" readonly disabled /></td>
                    </tr>
                    <tr>
                        <td>Name</td>
                        <td><input type="text" id="serie_name" required /></td>
                    </tr>
                </table>

                <h2>Competitions</h2>

                <table class="result">
                    <thead>
                        <tr>
                            <th class="result">Name</th>
                            <th class="result">Date</th>
                            <th class="result" style="width: 40px"></th>
                        </tr>
                    </thead>
                    <tbody id="competition_table">
                        <tr class="result">
                            <td class="result" colspan="3">No competitions found</td>
                        </tr>
                    </tbody>
                </table>
                <p>
                    <a href="javascript:addCompetition();">Add competition</a>
                    <br /><br /><br />
                    <input type="submit" value="Save" />&nbsp;<a href="index.html">Back</a>
                </p>

            </form>

        </div>
    </body>
</html>
