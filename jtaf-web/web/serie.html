<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Edit serie</title>
        <link rel="stylesheet" href="css/jtaf.css">
        <script src="javascript/util.js"></script>
        <script>
            var serie;

            function loadData() {
                var id = param().id;
                if (id === undefined) {
                    serie = new Object();
                    el("serie_name").focus();
                } else {
                    xhrGet("/jtaf/res/series/" + id, function(response) {
                        parseAndFillSerie(response);
                    });
                    xhrGet("/jtaf/res/categories?serie=" + id, function(response) {
                        parseAndFillCategories(response);
                    });
                    xhrGet("/jtaf/res/events?serie=" + id, function(response) {
                        parseAndFillEvents(response);
                    });

                    xhrGet("/jtaf/res/athletes?serie=" + id, function(response) {
                        parseAndFillAthletes(response);
                    });
                }
            }

            function parseAndFillSerie(response) {
                serie = JSON.parse(response);
                localStorage.setItem("serie", response);

                fillForm();
                fillCompetitionTable();
            }

            function fillForm() {
                el("serie_id").value = serie.id;
                el("serie_name").value = serie.name;
                el("serie_name").focus();
            }

            function fillCompetitionTable() {
                var table = el("competition_table");
                table.innerHTML = "";
                if (serie.competitions === undefined || serie.competitions.length === 0) {
                    var row = table.insertRow(0);
                    var cellName = row.insertCell(0);
                    cellName.innerHTML = "No competitions found";
                    cellName.setAttribute("colspan", 3);
                }
                else {
                    for (var i in serie.competitions) {
                        var competition = serie.competitions[i];
                        var row = table.insertRow(i);
                        var onclickEdit = "window.location = 'competition.html?id=" +
                                competition.id + "'";
                        var cellName = row.insertCell(0);
                        cellName.className = "edit";
                        cellName.innerHTML = competition.name;
                        cellName.setAttribute("onclick", onclickEdit);
                        var cellDate = row.insertCell(1);
                        cellDate.className = "edit";
                        cellDate.innerHTML = competition.competitionDate;
                        cellDate.setAttribute("onclick", onclickEdit);

                        var activate = document.createElement("a");
                        activate.setAttribute("href", "#");
                        activate.setAttribute("onclick", "activateCompetition(" +
                                competition.id + ")");
                        activate.appendChild(document.createTextNode("Activate"));

                        var ranking = document.createElement("a");
                        ranking.setAttribute("href", "competitionRanking.html?id=" + competition.id);
                        ranking.appendChild(document.createTextNode("Ranking"));

                        var del = document.createElement("a");
                        del.setAttribute("href", "#");
                        del.setAttribute("onclick", "deleteCompetition(" +
                                competition.id + ")");
                        del.appendChild(document.createTextNode("Delete"));

                        var cellFunction = row.insertCell(2);
                        cellFunction.appendChild(activate);
                        cellFunction.appendChild(document.createTextNode(" "));
                        cellFunction.appendChild(ranking);
                        cellFunction.appendChild(document.createTextNode(" "));
                        cellFunction.appendChild(del);
                    }
                }
            }

            function parseAndFillCategories(response) {
                var categories = JSON.parse(response);
                var table = el("category_table");
                table.innerHTML = "";
                if (categories === undefined || categories.length === 0) {
                    var row = table.insertRow(0);
                    var cellName = row.insertCell(0);
                    cellName.innerHTML = "No competitions found";
                    cellName.setAttribute("colspan", 6);
                }
                else {
                    for (var i in categories) {
                        var category = categories[i];
                        var row = table.insertRow(i);
                        var onclickEdit = "window.location = 'category.html?id=" +
                                category.id + "'";
                        var cellAbbr = row.insertCell(0);
                        cellAbbr.className = "edit";
                        cellAbbr.innerHTML = category.abbrevation;
                        cellAbbr.setAttribute("onclick", onclickEdit);
                        var cellName = row.insertCell(1);
                        cellName.className = "edit";
                        cellName.innerHTML = category.name;
                        cellName.setAttribute("onclick", onclickEdit);
                        var cellYearFrom = row.insertCell(2);
                        cellYearFrom.className = "edit";
                        cellYearFrom.innerHTML = category.yearFrom;
                        cellYearFrom.setAttribute("onclick", onclickEdit);
                        var cellYearTo = row.insertCell(3);
                        cellYearTo.className = "edit";
                        cellYearTo.innerHTML = category.yearTo;
                        cellYearTo.setAttribute("onclick", onclickEdit);
                        var cellGender = row.insertCell(4);
                        cellGender.className = "edit";
                        cellGender.innerHTML = category.gender;
                        cellGender.setAttribute("onclick", onclickEdit);
                        var del = document.createElement("a");
                        del.setAttribute("href", "#");
                        del.setAttribute("onclick", "deleteCategory(" +
                                category.id + ")");
                        del.appendChild(document.createTextNode("Delete"));
                        var cellFunction = row.insertCell(5);
                        cellFunction.appendChild(del);
                    }
                }
            }

            function parseAndFillEvents(response) {
                var events = JSON.parse(response);
                var table = el("event_table");
                table.innerHTML = "";
                if (events === undefined || events.length === 0) {
                    var row = table.insertRow(0);
                    var cellName = row.insertCell(0);
                    cellName.innerHTML = "No events found";
                    cellName.setAttribute("colspan", 8);
                }
                else {
                    for (var i in events) {
                        var event = events[i];
                        var row = table.insertRow(i);
                        var onclickEdit = "window.location = 'event.html?id=" +
                                event.id + "'";
                        var cellName = row.insertCell(0);
                        cellName.className = "edit";
                        cellName.innerHTML = event.name;
                        cellName.setAttribute("onclick", onclickEdit);
                        var cellType = row.insertCell(1);
                        cellType.className = "edit";
                        cellType.innerHTML = event.type;
                        cellType.setAttribute("onclick", onclickEdit);
                        var cellGender = row.insertCell(2);
                        cellGender.className = "edit";
                        cellGender.innerHTML = event.gender;
                        cellGender.setAttribute("onclick", onclickEdit);
                        var cellA = row.insertCell(3);
                        cellA.className = "edit";
                        cellA.innerHTML = event.a;
                        cellA.setAttribute("onclick", onclickEdit);
                        var cellB = row.insertCell(4);
                        cellB.className = "edit";
                        cellB.innerHTML = event.b;
                        cellB.setAttribute("onclick", onclickEdit);
                        var cellC = row.insertCell(5);
                        cellC.className = "edit";
                        cellC.innerHTML = event.c;
                        cellC.setAttribute("onclick", onclickEdit);
                        var del = document.createElement("a");
                        del.setAttribute("href", "#");
                        del.setAttribute("onclick", "deleteEvent(" + event.id + ")");
                        del.appendChild(document.createTextNode("Delete"));
                        var cellFunction = row.insertCell(6);
                        cellFunction.appendChild(del);
                    }
                }
            }

            function parseAndFillAthletes(response) {
                var athletes = JSON.parse(response);
                var table = el("athlete_table");
                table.innerHTML = "";
                if (athletes === undefined || athletes.length === 0) {
                    var row = table.insertRow(0);
                    var cellName = row.insertCell(0);
                    cellName.innerHTML = "No athletes found";
                    cellName.setAttribute("colspan", 8);
                }
                else {
                    for (var i in athletes) {
                        var athlete = athletes[i];
                        var row = table.insertRow(i);
                        var onclickEdit = "window.location = 'athlete.html?id=" +
                                athlete.id + "'";
                        var cellId = row.insertCell(0);
                        cellId.className = "edit";
                        cellId.innerHTML = athlete.id;
                        cellId.setAttribute("onclick", onclickEdit);
                        var cellLastName = row.insertCell(1);
                        cellLastName.className = "edit";
                        cellLastName.innerHTML = athlete.lastName;
                        cellLastName.setAttribute("onclick", onclickEdit);
                        var cellFirstName = row.insertCell(2);
                        cellFirstName.className = "edit";
                        cellFirstName.innerHTML = athlete.firstName;
                        cellFirstName.setAttribute("onclick", onclickEdit);
                        var cellYear = row.insertCell(3);
                        cellYear.className = "edit";
                        cellYear.innerHTML = athlete.year;
                        cellYear.setAttribute("onclick", onclickEdit);
                        var cellGender = row.insertCell(4);
                        cellGender.className = "edit";
                        cellGender.innerHTML = athlete.gender;
                        cellGender.setAttribute("onclick", onclickEdit);
                        var cellCategory = row.insertCell(5);
                        cellCategory.className = "edit";
                        cellCategory.innerHTML = athlete.category !== null
                                ? athlete.category.abbrevation : "";
                        cellCategory.setAttribute("onclick", onclickEdit);
                        var cellClub = row.insertCell(6);
                        cellClub.className = "edit";
                        cellClub.innerHTML = athlete.club !== null
                                ? athlete.club.name : "";
                        cellClub.setAttribute("onclick", onclickEdit);

                        var del = document.createElement("a");
                        del.setAttribute("href", "#");
                        del.setAttribute("onclick", "deleteAthlete(" + athlete.id + ")");
                        del.appendChild(document.createTextNode("Delete"));
                        var cellFunction = row.insertCell(7);
                        cellFunction.appendChild(del);
                    }
                }
            }

            function save() {
                fillSerie();
                xhrPost("/jtaf/res/series/", function(response) {
                    loadData();
                    info("Serie saved");
                }, serie);
            }

            function fillSerie() {
                serie.name = el("serie_name").value;
            }

            function deleteCompetition(id) {
                xhrDelete("/jtaf/res/competitions/" + id, function() {
                    loadData();
                    info("Competition deleted");
                });
            }

            function deleteCompetition(id) {
                xhrDelete("/jtaf/res/competitions/" + id, function() {
                    loadData();
                    info("Competition deleted");
                });
            }

            function activateCompetition(id) {
                for (var i in serie.competitions) {
                    var competition = serie.competitions[i];
                    if (competition.id === id) {
                        localStorage.setItem("competition", JSON.stringify(competition));
                        break;
                    }
                }
            }

            function deleteEvent(id) {
                xhrDelete("/jtaf/res/catgories/" + id, function() {
                    loadData();
                    info("Event deleted");
                });
            }

            function deleteAthlete(id) {
                xhrDelete("/jtaf/res/athletes/" + id, function() {
                    loadData();
                    info("Athlete deleted");
                });
            }
        </script>
    </head>
    <body onload="loadData();">
        <div id="main">
            <div id="navigation">
                <script src="javascript/navigation.js"></script>
            </div>

            <h1>Serie</h1>

            <form action="javascript:save();">

                <table class="input">
                    <tr>
                        <td>Id</td>
                        <td><input type="text" id="serie_id" readonly disabled /></td>
                    </tr>
                    <tr>
                        <td>Name</td>
                        <td><input type="text" id="serie_name" required /></td>
                    </tr>
                </table>

                <p>
                    <input type="submit" value="Save" />&nbsp;<a href="index.html">Back</a>
                </p>

                <h2>Competitions</h2>

                <table class="result">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Date</th>
                            <th style="width: 140px; text-align: right;"></th>
                        </tr>
                    </thead>
                    <tbody id="competition_table">
                        <tr>
                            <td colspan="3">Loading competitions</td>
                        </tr>
                    </tbody>
                </table>

                <p>
                    <a href="competition.html">Add competition</a>
                </p>

                <h2>Events</h2>

                <table class="result">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Gender</th>
                            <th>A</th>
                            <th>B</th>
                            <th>C</th>
                            <th style="width: 40px; text-align: right;"></th>
                        </tr>
                    </thead>
                    <tbody id="event_table">
                        <tr>
                            <td colspan="7">Loading events</td>
                        </tr>
                    </tbody>
                </table>

                <p>
                    <a href="event.html">Add event</a>
                </p>

                <h2>Categories</h2>

                <table class="result">
                    <thead>
                        <tr>
                            <th>Key</th>
                            <th>Name</th>
                            <th>From</th>
                            <th>To</th>
                            <th>Gender</th>
                            <th style="width: 40px; text-align: right;"></th>
                        </tr>
                    </thead>
                    <tbody id="category_table">
                        <tr>
                            <td colspan="6">Loading categories</td>
                        </tr>
                    </tbody>
                </table>

                <p>
                    <a href="category.html">Add category</a>
                </p>

                <h2>Athletes</h2>

                <table class="result">
                    <thead>
                        <tr>
                            <th>Id</th>
                            <th>Last name</th>
                            <th>First name</th>
                            <th>Year</th>
                            <th>Gender</th>
                            <th>Category</th>
                            <th>Club</th>
                            <th style="width: 40px; text-align: right;"></th>
                        </tr>
                    </thead>
                    <tbody id="athlete_table">
                        <tr>
                            <td colspan="8">Loading athletes</td>
                        </tr>
                    </tbody>
                </table>

                <p>
                    <a href="athlete.html">Add athlete</a>
                </p>

            </form>

        </div>
    </body>
</html>
