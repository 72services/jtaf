<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Edit Category</title>
        <link rel="stylesheet" href="css/jtaf.css">

        <script src="javascript/util.js"></script>
        <script src="javascript/navigation.js"></script>
        <script>
            var category;
            var serie;
            var events;

            function loadData() {
                var s = sessionStorage.getItem("serie");
                serie = JSON.parse(s);

                if (events === undefined) {
                    sendRequest("GET", "/jtaf/res/events", 200, function(response) {
                        events = JSON.parse(response);
                    });
                }

                var id = param().id;
                if (id === undefined) {
                    category = new Object();
                    fillEventsTable();
                    el("category_abbr").focus();
                } else {
                    sendRequest("GET", "/jtaf/res/categories/" + id, 200, function(response) {
                        parseAndFill(response);
                    });
                }
            }

            function back() {
                window.location = "serie.html?id=" + serie.id;
            }

            function parseAndFill(response) {
                category = JSON.parse(response);
                fillForm();
            }

            function fillForm() {
                el("category_id").value = category.id;
                el("category_abbr").value = category.abbrevation;
                el("category_name").value = category.name;
                el("category_yearFrom").value = category.yearFrom;
                el("category_yearTo").value = category.yearTo;
                if (category.gender === "m") {
                    el("category_gender_m").checked = true;
                }
                else {
                    el("category_gender_f").checked = true;
                }
                fillEventsTable();
                el("category_abbr").focus();
            }

            function fillEventsTable() {
                var table = el("category_events");
                table.innerHTML = "";

                for (var i = 0; i < 10; i++) {
                    var row = table.insertRow(i);
                    var cellNo = row.insertCell(0);
                    cellNo.innerHTML = i + 1;
                    var cell = row.insertCell(1);
                    var select = document.createElement("select");
                    select.id = "select" + i;
                    var option = document.createElement("option");
                    option.innerHTML = "";
                    select.appendChild(option);
                    for (var e in events) {
                        var ev = events[e];
                        var option = document.createElement("option");
                        option.value = ev.id;
                        option.innerHTML = ev.name;
                        select.appendChild(option);
                        if (category.events[i] !== undefined &&
                                category.events[i].id === ev.id) {
                            option.selected = true;
                        }
                    }
                    cell.appendChild(select);
                }
            }

            function save() {
                fillCategory();
                var message = JSON.stringify(category);
                console.log(message);
                sendRequest("POST", "/jtaf/res/categories/", 200, function(response) {
                    parseAndFill(response);
                    info("Category saved");
                }, "application/json", message);
            }

            function fillCategory() {
                category.abbrevation = el("category_abbr").value;
                category.name = el("category_name").value;
                category.yearFrom = el("category_yearFrom").value;
                category.yearTo = el("category_yearTo").value;
                if (el("category_gender_m").checked) {
                    category.gender = "m";
                } else {
                    category.gender = "f";
                }
                getEvents();
                category.serie = serie;
            }

            function getEvents() {
                var jtafEvents = [];
                var j = 0;
                for (var i = 0; i < 10; i++) {
                    var select = el("select" + i);
                    var id = select.options[select.selectedIndex].value;
                    console.log(id);
                    for (var e in events) {
                        var jtafEvent = events[e];
                        if (jtafEvent.id == id) {
                            jtafEvents[j] = jtafEvent;
                        }
                    }
                }
                category.events = jtafEvents;
            }

            function deleteCategory(id) {
                sendRequest("DELETE", "/jtaf/res/categories/" + id, 204, function() {
                    loadData();
                    info("Category deleted");
                });
            }
        </script>
    </head>
    <body onload="loadData();">
        <div id="main">
            <div id="navigation">
                <script src="javascript/navigation.js"></script>
            </div>

            <h1>Category</h1>

            <form action="javascript:save();">

                <table class="input">
                    <tr>
                        <td>Id</td>
                        <td><input type="text" id="category_id" readonly disabled /></td>
                    </tr>
                    <tr>
                        <td>Abbrevation</td>
                        <td><input type="text" id="category_abbr" required /></td>
                    </tr>
                    <tr>
                        <td>Name</td>
                        <td><input type="text" id="category_name" required /></td>
                    </tr>
                    <tr>
                        <td>Year from</td>
                        <td><input type="number" min="1900" max="2000" id="category_yearFrom" required /></td>
                    </tr>
                    <tr>
                        <td>Year to</td>
                        <td><input type="number" min="1900" max="2000" id="category_yearTo" required /></td>
                    </tr>
                    <tr>
                        <td>Gender</td>
                        <td>
                            <input id="category_gender_m" type="radio" name="category_gender" value="m">m
                            <input id="category_gender_f" type="radio" name="category_gender" value="f">f
                        </td>
                    </tr>
                    <tr>
                        <td>Events</td>
                        <td>
                            <table id="category_events" class="events">
                            </table>
                        </td>
                    </tr>
                </table>

                <p>
                    <input type="submit" value="Save" />&nbsp;
                    <a href="javascript:back();">Back</a>
                </p>

            </form>

        </div>
    </body>
</html>
